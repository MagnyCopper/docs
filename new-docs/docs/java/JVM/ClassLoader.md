# 类加载机制 <!-- omit in toc -->

> 这里是关于 JVM 类的加载机制相关描述;

目录:

- [基础属性](#基础属性)
  - [加载](#加载)
  - [验证](#验证)
  - [准备](#准备)
  - [解析](#解析)
  - [初始化](#初始化)
  - [卸载](#卸载)
- [知识点](#知识点)
  - [数组类如何创建?](#数组类如何创建)
  - [系统类加载器加载的类能否被卸载?](#系统类加载器加载的类能否被卸载)
  - [系统类加载器](#系统类加载器)

## 基础属性

JVM 加载类的主要流程:

- 加载
- 验证
- 准备
- 解析
- 初始化
- 使用
- 卸载

### 加载

步骤如下:

1. 通过类全名获取定义该类的二进制字节流;
2. 将字节流所代表的静态存储结构转换为方法区的运行时数据结构;
3. 在内存中生成一个代表该类的 class 对象,作为方法区中访问这个数据的入口;

加载和验证流程可能会同步进行,一边加载一边验证;

### 验证

步骤如下:

1. 文件格式验证:判断是否符合 class 文件格式/版本号是否合规等
2. 元数据验证:验证父类合法性/是否继承 final 类等;
3. 字节码验证:判断代码逻辑是否正常
4. 符号引用验证;

### 准备

为类变量分配内存并设置初始值的阶段,主要是在方法区的内存上分配;

几个说明:

1. 类变量主要是指被 static 修饰的变量,为他们分配内存;
2. 初始值并不是为其赋值,这里仅作初始化,比如我们定义了`public static int value=111` ，那么 value 变量在准备阶段的初始值就是 0 而不是 111（初始化阶段才会赋值）

### 解析

解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程(符号引用转为指针地址/偏移量)。解析动作主要针对类或接口、字段、类方法、接口方法、方法类型、方法句柄和调用限定符 7 类符号引用进行。

### 初始化

执行初始化方法`<clinit> ()`,线程安全,完成静态变量赋值;

### 卸载

卸载类需要满足 3 个要求:

- 该类的所有的实例对象都已被 GC，也就是说堆不存在该类的实例对象。
- 该类没有在其他任何地方被引用
- 该类的类加载器的实例已被 GC

满足以上要求的,将**有可能**被卸载;

## 知识点

### 数组类如何创建?

数组类型不通过类加载器创建，它由 Java 虚拟机直接创建。

### 系统类加载器加载的类能否被卸载?

JDK 自带的 BootstrapClassLoader/ExtClassLoader/AppClassLoader 由于不会被回收因此被他们加载的类也不会被卸载;

自定义的类加载器是可以被回收的因此使用自定义类加载器加载的类有可能被卸载;

### 系统类加载器

JVM 中内置了 3 个 ClassLoader:

- BootstrapClassLoader(启动类加载器):最顶层的加载类,负责加载%JAVA_HOME%/lib 目录下的 jar 包和类
- ExtensionClassLoader(扩展类加载器):主要负责加载 %JRE_HOME%/lib/ext 目录下的 jar 包和类
- AppClassLoader(应用程序类加载器):负责加载当前应用 classpath 下的所有 jar 包和类
