# CAS <!-- omit in toc -->

> CAS，即 Compare And Swap(比较与交换)，是一种无锁算法，基于硬件原语实现，能够在不使用锁的情况下实现多线程之间的变量同步;

目录:

- [基础属性](#基础属性)
  - [CAS 工作流程](#cas-工作流程)
  - [LongAdder](#longadder)
- [知识点](#知识点)
  - [CAS 算法的弊端?如何解决?](#cas-算法的弊端如何解决)

## 基础属性

### CAS 工作流程

该算法主要涉及 3 个操作数:

- 需要读写的内存位置 V
- 需要进行比较的预期值 A
- 需要写入的新值 U

执行时,当且仅当预期值 A 符合内存地址 V 中存储的值时，就用新值 U 替换掉旧值，并写入到内存地址 V 中。否则不做更新。

### LongAdder

LongAdder 的功能类似于 AtomicLong，在低并发度的场景这 2 者性能差异较小，在高并发度场景差异巨大；

add 处理流程：

- 无争抢时通过 CAS 更新 base 的值；
- 有争抢时，计算线程的 hash 引导至 cell 数组更新对应元素的值；
- cell 数组上发生争抢时通过扩容至原来 2 倍的方式重新 rehash 后更新对应 cell 的值；

## 知识点

### CAS 算法的弊端?如何解决?

问题 1：

CAS 算法无法处理 ABA 类型的问题，即 A 线程在执行 CAS 期间，B 线程也获取了资源并修改了 V 对应的值且最后又修改回原值导致 A 线程的 CAS 锁失效；

如何解决：

- 通过添加版本号的方式，即每个线程修改值后均需要将版本号+1，CAD 过程中将版本号也作为比较环节的依据即可；

问题 2：

多个线程产生竞争时将产生大量循环等待线程，对 CPU 开销较大

如何解决：

- 降低循环次数，及时退出循环；
- 使用 LongAdder 优化过的 CAS；
