# 关键字 <!-- omit in toc -->

> 这里是一些在多线程场景会使用到的关键字;

目录:

- [基础属性](#基础属性)
- [知识点](#知识点)
  - [volatile 的效果](#volatile-的效果)
  - [volatile 的实现原理](#volatile-的实现原理)
  - [volatile 的注意事项](#volatile-的注意事项)
  - [happens-before 规则](#happens-before-规则)
  - [synchronized 的效果](#synchronized-的效果)
  - [JDK6 之后对 synchronized 的优化](#jdk6-之后对-synchronized-的优化)

## 基础属性

主要涉及以下关键字

- **volatile**：使用该关键子来保证多线程场景的可见性及一部分有序性;
- **synchronized**：保证被它修饰的方法或者代码块在任意时刻只能有一个线程执行;

## 知识点

### volatile 的效果

- **可见性**：当一个共享变量被 volatile 修饰时，它会保证修改的值会立即被更新到主存，当有其他线程需要读取时，它会去内存中读取新值。
- **有序性**：禁止 JVM 进行指令重排序

额外的效果

- 写入 volatile 变量时，线程中的所有变量都会触发写入主存。
- 读取 volatile 变量时，线程中的所有变量都会出发从主存中重新读取。

### volatile 的实现原理

添加 volatile 关键字后在生成的汇编代码中多了 LOCK 前缀指令（内存屏障），内存屏障的作用如下：

- 确保指令重排序时不会把其后面的指令排到内存屏障之前的位置；
- 强制将对缓存的修改操作立即写入主存
- 如果是写操作，它会导致其他 CPU 中对应的缓存行无效

### volatile 的注意事项

由于 volatile 的特点，在使用时应注意以下几个点：

- 读取 volatile 修饰的变量时，应尽量放在最开头的位置，以保证其他变量是由 CPU 内存刷新过后的新值；
- 写入 volatile 修饰的变量时，应尽量放在最结尾的位置，以保证其他变量值能够写入 CPU 内存；

在使用 volatile 修饰变量前应确保，以下几点才能保证其安全

- 变量的写操作不依赖于当前值；
- 该变量没有包含在具有其他变量的不变式中

### happens-before 规则

happens-before 规则用来描述多线程之间的内存可见性，主要内容如下：

- 程序次序规则：一个线程内，按照代码顺序，书写在前面的操作先行发生于书写在后面的操作；
- 锁定规则：一个 unLock 操作先行发生于后面对同一个锁额 lock 操作；
- volatile 变量规则：对一个变量的写操作先行发生于后面对这个变量的读操作；
- 传递规则：如果操作 A 先行发生于操作 B，而操作 B 又先行发生于操作 C，则可以得出操作 A 先行发生于操作 C；
- 线程启动规则：Thread 对象的 start()方法先行发生于此线程的每个一个动作；
- 线程中断规则：对线程 interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生；
- 线程终结规则：线程中所有的操作都先行发生于线程的终止检测，我们可以通过 Thread.join()方法结束、- Thread.isAlive()的返回值手段检测到线程已经终止执行；
- 对象终结规则：一个对象的初始化完成先行发生于他的 finalize()方法的开始；

### synchronized 的效果

synchronized 关键字用来保证被修饰的方法或代码在同一时间只能被一个线程访问；

分 3 种情况说明：

- **修饰方法**：对象锁，即 this，对象的多个 synchronized 修饰的方法会阻塞，不同对象间的 synchronized 方法不会阻塞；
- **修饰 static 静态方法**：类锁，即 class，全部对象的 synchronized 修饰的静态方法会阻塞，与 synchronized 修饰的普通方法不阻塞；
- **修饰类**：取决于 synchronized 锁的 Object 是什么来决定；

### JDK6 之后对 synchronized 的优化

- **锁膨胀**：按照无锁->偏向锁-轻量级锁->重量级锁依次升级（原来都是基于重量级锁实现频繁设计内核态用户态切换）；
- **锁消除**：JVM 虚拟机如果检测不到某段代码被共享和竞争的可能性，就会将这段代码所属的同步锁消除掉
- **锁粗化**：将多个连续的加锁、解锁操作连接在一起，扩展成一个范围更大的锁。
- **自适应自旋锁**：锁实现过程中涉及的 CAS 操作中的自旋次数将根据情况动态调整；
